name: Docker Image Backend CI

on:
  push:
    branches: ["main"]
    paths:
      - "packages/backend/**"
      - ".github/workflows/backend.yml"
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'packages/backend/**'
    outputs:
      backend: ${{ steps.filter.outputs.backend }}

  test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable && corepack prepare yarn@4.10.3 --activate
      - run: yarn install --immutable
      - working-directory: packages/backend
        run: yarn test --ci

    build_and_push:
      runs-on: ubuntu-latest
      needs: test
      if: needs.changes.outputs.backend == 'true'
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log in to DockerHub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Enable Corepack and install Yarn 4.10.3
          run: |
            corepack enable
            corepack prepare yarn@4.10.3 --activate

        - name: Generate version from commit count
          id: version
          run: |
            VERSION=$(git rev-list --count HEAD)
            echo "VERSION=1.${VERSION}" >> $GITHUB_ENV

        - name: Get the current timestamp
          id: timestamp
          run: echo "TIMESTAMP=$(date +'%Y%m%d%H')" >> $GITHUB_ENV

        - name: Build Node.js API image
          run: |
            docker buildx build \
              --platform linux/amd64 \
              --file packages/backend/Dockerfile \
              --tag ${{ secrets.DOCKER_USERNAME }}/planify_backend:${{ env.TIMESTAMP }}-v${{ env.VERSION }} \
              --tag ${{ secrets.DOCKER_USERNAME }}/planify_backend:latest \
              --push \
              .
